name: ğŸ iOS CI

on:
  pull_request:
    branches: [ main ]

jobs:
  ios-build-test:
    name: Build and Test
    runs-on: self-hosted
    steps:
    - name: Configure Git
      run: |
        git config --global http.postBuffer 524288000
        git config --global http.maxRequestBuffer 100M
        git config --global core.compression 0
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        git config --global http.version HTTP/1.1
        git config --global protocol.version 1
        
    - name: Clean workspace before checkout
      run: rm -rf ./* ./.[!.]* 2>/dev/null || true
    
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
        token: ${{ secrets.GITHUB_TOKEN }}
        clean: true
        ref: ${{ github.event.pull_request.head.sha }}

    # 1ï¸âƒ£ Tuist ì„¤ì¹˜ (self-hosted runnerì—ëŠ” ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ)
    # - name: Install Tuist (brew)
    #   run: |
    #     brew update
    #     brew tap tuist/tuist
    #     brew install tuist
    #     
    # - name: Add Tuist to PATH
    #   run: echo "$HOME/.tuist/bin" >> $GITHUB_PATH

    - name: Clean workspace completely
      run: |
        rm -rf *.xcodeproj
        rm -rf *.xcworkspace
        rm -rf .package.resolved
        rm -rf **/Package.resolved
        rm -rf Derived
        rm -rf .tuist
        tuist clean
        
    # 2ï¸âƒ£ í”„ë¡œì íŠ¸ ìƒì„± (workspace, scheme ìë™ ìƒì„±)
    - name: Generate Xcode project with Tuist
      run: tuist generate --no-open --no-binary-cache

    # 3ï¸âƒ£ ì‹¤ì œ ë¹Œë“œ
    - name: Build project
      run: |
        xcodebuild -workspace MZMZ.xcworkspace \
                   -scheme "MZMZ" \
                   -destination 'platform=iOS Simulator,name=iPhone 16' \
                   clean build

    # 5ï¸âƒ£ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ íƒ€ê¹ƒ ì‹¤í–‰
    - name: Run DustListView tests
      run: |
        xcodebuild test \
                   -workspace MZMZ.xcworkspace \
                   -scheme DustListView \
                   -destination 'platform=iOS Simulator,name=iPhone 16'
